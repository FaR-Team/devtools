<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Palette Editor</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-dark: #27ae60;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .container {
            display: flex;
            gap: 30px;
        }
        
        .editor-panel {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .library-panel {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-height: 800px;
            overflow-y: auto;
        }
        
        .color-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.02);
        }
        
        .color-label {
            width: 80px;
            font-weight: 600;
        }
        
        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            margin: 0 15px;
            box-shadow: var(--shadow);
        }
        
        input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        input[type="text"] {
            width: 100px;
            margin: 0 15px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
        }
        
        input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .palette-name {
            margin-bottom: 20px;
        }
        
        .palette-name input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }
        
        .buttons {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        button.secondary {
            background-color: var(--secondary-color);
        }
        
        button.secondary:hover {
            background-color: var(--secondary-dark);
        }
        
        .palette-preview {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
        }
        
        .preview-row {
            height: 50px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
        }
        
        .section h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .image-preview {
            display: flex;
            margin-top: 15px;
            gap: 10px;
        }
        
        .pixel {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 5px;
        }
        
        .library-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.02);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .library-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .library-item-name {
            flex: 1;
            font-weight: bold;
        }
        
        .library-item-colors {
            display: flex;
            gap: 5px;
        }
        
        .library-color {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 200px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .empty-library {
            text-align: center;
            padding: 40px 0;
            color: #7f8c8d;
        }
        
        .empty-library i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <h1><i class="fas fa-palette"></i> Color Palette Editor</h1>
        <p>Create and edit color palettes for RoomMakers without needing Unity.</p>
    </header>
    
    <div class="container">
        <div class="editor-panel">
            <div class="tabs">
                <div class="tab active" data-tab="editor">Editor</div>
                <div class="tab" data-tab="image-import">Image Import</div>
            </div>
            
            <div class="tab-content active" id="editor-tab">
                <div class="palette-name">
                    <label for="paletteName">Palette Name:</label>
                    <input type="text" id="paletteName" value="NewPalette" placeholder="Enter palette name...">
                </div>
                
                <div class="color-row">
                    <span class="color-label">Darkest:</span>
                    <input type="color" id="darkestColor" value="#000000">
                    <input type="text" id="darkestHex" value="#000000">
                    <div class="color-preview" id="darkestPreview"></div>
                </div>
                
                <div class="color-row">
                    <span class="color-label">Dark:</span>
                    <input type="color" id="darkColor" value="#333333">
                    <input type="text" id="darkHex" value="#333333">
                    <div class="color-preview" id="darkPreview"></div>
                </div>
                
                <div class="color-row">
                    <span class="color-label">Light:</span>
                    <input type="color" id="lightColor" value="#BBBBBB">
                    <input type="text" id="lightHex" value="#BBBBBB">
                    <div class="color-preview" id="lightPreview"></div>
                </div>
                
                <div class="color-row">
                    <span class="color-label">Lightest:</span>
                    <input type="color" id="lightestColor" value="#FFFFFF">
                    <input type="text" id="lightestHex" value="#FFFFFF">
                    <div class="color-preview" id="lightestPreview"></div>
                </div>
                
                <div class="palette-preview">
                    <h3><i class="fas fa-eye"></i> Palette Preview</h3>
                    <div class="preview-row" id="darkestRow"></div>
                    <div class="preview-row" id="darkRow"></div>
                    <div class="preview-row" id="lightRow"></div>
                    <div class="preview-row" id="lightestRow"></div>
                </div>
                
                <div class="buttons">
                    <button id="saveBtn"><i class="fas fa-save"></i> Save Palette</button>
                    <button id="loadBtn"><i class="fas fa-folder-open"></i> Load Palette</button>
                    <button id="addToLibraryBtn" class="secondary"><i class="fas fa-plus"></i> Add to Library</button>
                </div>
            </div>
            
            <div class="tab-content" id="image-import-tab">
                <div class="section">
                    <h2><i class="fas fa-image"></i> Import from Image</h2>
                    <p>Upload a 4-pixel image (horizontal or vertical) to extract colors. The colors will be assigned in order: Darkest, Dark, Light, Lightest.</p>
                    <input type="file" id="imageInput" accept="image/*">
                    <div id="imageError" class="error" style="display: none;"></div>
                    <div class="image-preview">
                        <div class="pixel" id="pixel0"></div>
                        <div class="pixel" id="pixel1"></div>
                        <div class="pixel" id="pixel2"></div>
                        <div class="pixel" id="pixel3"></div>
                    </div>
                    <button id="applyImageBtn" style="margin-top: 20px; display: none;"><i class="fas fa-check"></i> Apply Colors</button>
                </div>
            </div>
        </div>
        
        <div class="library-panel">
            <div class="library-header">
                <h2><i class="fas fa-book"></i> Palette Library</h2>
                <input type="text" class="search-box" id="searchLibrary" placeholder="Search palettes...">
            </div>
            
            <div id="paletteLibrary">
                <!-- Library items will be added here dynamically -->
                <div class="empty-library" id="emptyLibrary">
                    <i class="fas fa-folder-open"></i>
                    <p>Your palette library is empty. Add palettes to see them here.</p>
                </div>
            </div>
        </div>
    </div>
    
    <input type="file" id="fileInput" style="display: none;">
    
    <script>
        // Initialize color pickers and hex inputs
        const colorInputs = ['darkest', 'dark', 'light', 'lightest'];
        let extractedColors = [];
        let paletteLibrary = [];
        
        // Load library from local storage
        function loadLibrary() {
            const savedLibrary = localStorage.getItem('paletteLibrary');
            if (savedLibrary) {
                paletteLibrary = JSON.parse(savedLibrary);
                renderLibrary();
            }
        }
        
        // Save library to local storage
        function saveLibrary() {
            localStorage.setItem('paletteLibrary', JSON.stringify(paletteLibrary));
        }
        
        // Render the palette library
        function renderLibrary() {
            const libraryElement = document.getElementById('paletteLibrary');
            const emptyLibrary = document.getElementById('emptyLibrary');
            const searchTerm = document.getElementById('searchLibrary').value.toLowerCase();
            
            // Filter palettes based on search term
            const filteredPalettes = paletteLibrary.filter(palette => 
                palette.name.toLowerCase().includes(searchTerm)
            );
            
            // Clear current library
            libraryElement.innerHTML = '';
            
            if (filteredPalettes.length === 0) {
                libraryElement.appendChild(emptyLibrary);
                return;
            }
            
            // Add each palette to the library
            filteredPalettes.forEach((palette, index) => {
                const paletteItem = document.createElement('div');
                paletteItem.className = 'library-item';
                paletteItem.dataset.index = index;
                paletteItem.innerHTML = `
                                        <div class="library-item-name">${palette.name}</div>
                    <div class="library-item-colors">
                        <div class="library-color" style="background-color: ${palette.darkestHex}"></div>
                        <div class="library-color" style="background-color: ${palette.darkHex}"></div>
                        <div class="library-color" style="background-color: ${palette.lightHex}"></div>
                        <div class="library-color" style="background-color: ${palette.lightestHex}"></div>
                    </div>
                    <div class="library-item-actions">
                        <button class="load-palette-btn" data-index="${index}" title="Load Palette"><i class="fas fa-upload"></i></button>
                        <button class="delete-palette-btn" data-index="${index}" title="Delete Palette"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                libraryElement.appendChild(paletteItem);
                
                // Add click event to load the palette
                paletteItem.querySelector('.load-palette-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    loadPaletteFromLibrary(index);
                });
                
                // Add click event to delete the palette
                paletteItem.querySelector('.delete-palette-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePaletteFromLibrary(index);
                });
                
                // Add click event to the whole item to load the palette
                paletteItem.addEventListener('click', () => {
                    loadPaletteFromLibrary(index);
                });
            });
        }
        
        // Load a palette from the library
        function loadPaletteFromLibrary(index) {
            const palette = paletteLibrary[index];
            
            // Update palette name
            document.getElementById('paletteName').value = palette.name;
            
            // Update colors
            document.getElementById('darkestHex').value = palette.darkestHex;
            document.getElementById('darkestColor').value = palette.darkestHex;
            document.getElementById('darkestPreview').style.backgroundColor = palette.darkestHex;
            document.getElementById('darkestRow').style.backgroundColor = palette.darkestHex;
            
            document.getElementById('darkHex').value = palette.darkHex;
            document.getElementById('darkColor').value = palette.darkHex;
            document.getElementById('darkPreview').style.backgroundColor = palette.darkHex;
            document.getElementById('darkRow').style.backgroundColor = palette.darkHex;
            
            document.getElementById('lightHex').value = palette.lightHex;
            document.getElementById('lightColor').value = palette.lightHex;
            document.getElementById('lightPreview').style.backgroundColor = palette.lightHex;
            document.getElementById('lightRow').style.backgroundColor = palette.lightHex;
            
            document.getElementById('lightestHex').value = palette.lightestHex;
            document.getElementById('lightestColor').value = palette.lightestHex;
            document.getElementById('lightestPreview').style.backgroundColor = palette.lightestHex;
            document.getElementById('lightestRow').style.backgroundColor = palette.lightestHex;
            
            // Switch to editor tab
            document.querySelector('.tab[data-tab="editor"]').click();
        }
        
        // Delete a palette from the library
        function deletePaletteFromLibrary(index) {
            if (confirm(`Are you sure you want to delete the palette "${paletteLibrary[index].name}"?`)) {
                paletteLibrary.splice(index, 1);
                saveLibrary();
                renderLibrary();
            }
        }
        
        // Add current palette to library
        function addToLibrary() {
            const paletteName = document.getElementById('paletteName').value || 'NewPalette';
            
            // Check if palette with this name already exists
            const existingIndex = paletteLibrary.findIndex(p => p.name === paletteName);
            
            const paletteData = {
                name: paletteName,
                darkestHex: document.getElementById('darkestHex').value,
                darkHex: document.getElementById('darkHex').value,
                lightHex: document.getElementById('lightHex').value,
                lightestHex: document.getElementById('lightestHex').value
            };
            
            if (existingIndex >= 0) {
                if (confirm(`A palette named "${paletteName}" already exists. Do you want to replace it?`)) {
                    paletteLibrary[existingIndex] = paletteData;
                } else {
                    return;
                }
            } else {
                paletteLibrary.push(paletteData);
            }
            
            saveLibrary();
            renderLibrary();
            
            alert(`Palette "${paletteName}" has been added to your library.`);
        }
        
        // Initialize tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and tab contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding tab content
                const tabName = tab.dataset.tab;
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
        
        // Initialize color inputs
        colorInputs.forEach(type => {
            const colorInput = document.getElementById(`${type}Color`);
            const hexInput = document.getElementById(`${type}Hex`);
            const preview = document.getElementById(`${type}Preview`);
            const previewRow = document.getElementById(`${type}Row`);
            
            // Update hex when color changes
            colorInput.addEventListener('input', () => {
                hexInput.value = colorInput.value;
                preview.style.backgroundColor = colorInput.value;
                previewRow.style.backgroundColor = colorInput.value;
            });
            
            // Update color when hex changes
            hexInput.addEventListener('input', () => {
                if (/^#[0-9A-F]{6}$/i.test(hexInput.value)) {
                    colorInput.value = hexInput.value;
                    preview.style.backgroundColor = hexInput.value;
                    previewRow.style.backgroundColor = hexInput.value;
                }
            });
            
            // Initialize preview
            preview.style.backgroundColor = colorInput.value;
            previewRow.style.backgroundColor = colorInput.value;
        });
        
        // Image upload and processing
        document.getElementById('imageInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    processImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        function processImage(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const errorElement = document.getElementById('imageError');
            const applyBtn = document.getElementById('applyImageBtn');
            
            // Check if image is suitable (either 4x1 or 1x4)
            if ((img.width === 4 && img.height === 1) || (img.width === 1 && img.height === 4)) {
                errorElement.style.display = 'none';
                applyBtn.style.display = 'block';
                
                extractedColors = [];
                
                // Extract colors
                if (img.width === 4) {
                    for (let x = 0; x < 4; x++) {
                        const pixelData = ctx.getImageData(x, 0, 1, 1).data;
                        const color = rgbToHex(pixelData[0], pixelData[1], pixelData[2]);
                        extractedColors.push(color);
                        document.getElementById(`pixel${x}`).style.backgroundColor = color;
                    }
                } else {
                    for (let y = 0; y < 4; y++) {
                        const pixelData = ctx.getImageData(0, y, 1, 1).data;
                        const color = rgbToHex(pixelData[0], pixelData[1], pixelData[2]);
                        extractedColors.push(color);
                        document.getElementById(`pixel${y}`).style.backgroundColor = color;
                    }
                }
            } else {
                errorElement.textContent = 'Image must be exactly 4x1 or 1x4 pixels.';
                errorElement.style.display = 'block';
                applyBtn.style.display = 'none';
                
                // Clear pixel previews
                for (let i = 0; i < 4; i++) {
                    document.getElementById(`pixel${i}`).style.backgroundColor = 'transparent';
                }
            }
        }
        
        document.getElementById('applyImageBtn').addEventListener('click', () => {
            if (extractedColors.length === 4) {
                // Apply colors to the palette
                const types = ['darkest', 'dark', 'light', 'lightest'];
                
                types.forEach((type, index) => {
                    const color = extractedColors[index];
                    document.getElementById(`${type}Color`).value = color;
                    document.getElementById(`${type}Hex`).value = color;
                    document.getElementById(`${type}Preview`).style.backgroundColor = color;
                    document.getElementById(`${type}Row`).style.backgroundColor = color;
                });
                
                // Switch to editor tab
                document.querySelector('.tab[data-tab="editor"]').click();
            }
        });
        
        function rgbToHex(r, g, b) {
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Save palette to JSON file
        document.getElementById('saveBtn').addEventListener('click', () => {
            const paletteName = document.getElementById('paletteName').value || 'NewPalette';
            
            const paletteData = {
                name: paletteName,
                darkestHex: document.getElementById('darkestHex').value,
                darkHex: document.getElementById('darkHex').value,
                lightHex: document.getElementById('lightHex').value,
                lightestHex: document.getElementById('lightestHex').value
            };
            
            const jsonData = JSON.stringify(paletteData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${paletteName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Load palette from JSON file
        document.getElementById('loadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const paletteData = JSON.parse(e.target.result);
                    
                    // Update palette name
                    document.getElementById('paletteName').value = paletteData.name || 'NewPalette';
                    
                    // Update colors
                    if (paletteData.darkestHex) {
                        document.getElementById('darkestHex').value = paletteData.darkestHex;
                        document.getElementById('darkestColor').value = paletteData.darkestHex;
                        document.getElementById('darkestPreview').style.backgroundColor = paletteData.darkestHex;
                        document.getElementById('darkestRow').style.backgroundColor = paletteData.darkestHex;
                    }
                    
                    if (paletteData.darkHex) {
                        document.getElementById('darkHex').value = paletteData.darkHex;
                        document.getElementById('darkColor').value = paletteData.darkHex;
                        document.getElementById('darkPreview').style.backgroundColor = paletteData.darkHex;
                        document.getElementById('darkRow').style.backgroundColor = paletteData.darkHex;
                    }
                    
                    if (paletteData.lightHex) {
                        document.getElementById('lightHex').value = paletteData.lightHex;
                        document.getElementById('lightColor').value = paletteData.lightHex;
                        document.getElementById('lightPreview').style.backgroundColor = paletteData.lightHex;
                        document.getElementById('lightRow').style.backgroundColor = paletteData.lightHex;
                    }
                    
                    if (paletteData.lightestHex) {
                        document.getElementById('lightestHex').value = paletteData.lightestHex;
                        document.getElementById('lightestColor').value = paletteData.lightestHex;
                        document.getElementById('lightestPreview').style.backgroundColor = paletteData.lightestHex;
                        document.getElementById('lightestRow').style.backgroundColor = paletteData.lightestHex;
                    }
                } catch (error) {
                    alert('Error loading palette: ' + error.message);
                }
            };
            reader.readAsText(file);
        });
        
        // Add to library button
        document.getElementById('addToLibraryBtn').addEventListener('click', addToLibrary);
        
        // Search library
        document.getElementById('searchLibrary').addEventListener('input', renderLibrary);
        
        // Load library on page load
        loadLibrary();
        
        saveLibrary();
        renderLibrary();

        
        // Add export all functionality
        function exportAllPalettes() {
            if (paletteLibrary.length === 0) {
                alert("Your palette library is empty. Add some palettes first.");
                return;
            }
            
            // Create a zip file containing all palettes
            const zip = new JSZip();
            
            paletteLibrary.forEach(palette => {
                const jsonData = JSON.stringify(palette, null, 2);
                zip.file(`${palette.name}.json`, jsonData);
            });
            
            zip.generateAsync({type: "blob"}).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = "RoomMakers_Palettes.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
        
        // Add import all functionality
        function importAllPalettes(files) {
            if (files.length === 0) return;
            
            let importCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.name.endsWith('.json')) continue;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const paletteData = JSON.parse(e.target.result);
                        
                        // Check if palette with this name already exists
                        const existingIndex = paletteLibrary.findIndex(p => p.name === paletteData.name);
                        
                        if (existingIndex >= 0) {
                            paletteLibrary[existingIndex] = paletteData;
                        } else {
                            paletteLibrary.push(paletteData);
                        }
                        
                        importCount++;
                        
                        // If this is the last file, save and render
                        if (i === files.length - 1) {
                            saveLibrary();
                            renderLibrary();
                            alert(`Imported ${importCount} palettes to your library.`);
                        }
                    } catch (error) {
                        console.error(`Error importing ${file.name}: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveBtn').click();
            }
            
            // Ctrl+O to load
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                document.getElementById('loadBtn').click();
            }
            
            // Ctrl+L to add to library
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                addToLibrary();
            }
        });
        
        // Add drag and drop support for the image import
        const imageDropZone = document.getElementById('image-import-tab');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            imageDropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            imageDropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            imageDropZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            imageDropZone.classList.add('highlight');
        }
        
        function unhighlight() {
            imageDropZone.classList.remove('highlight');
        }
        
        imageDropZone.addEventListener('drop', handleImageDrop, false);
        
        function handleImageDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                document.getElementById('imageInput').files = files;
                const event = new Event('change');
                document.getElementById('imageInput').dispatchEvent(event);
            }
        }
        
        // Add drag and drop support for the library
        const libraryDropZone = document.getElementById('paletteLibrary');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            libraryDropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            libraryDropZone.addEventListener(eventName, () => {
                libraryDropZone.classList.add('highlight');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            libraryDropZone.addEventListener(eventName, () => {
                libraryDropZone.classList.remove('highlight');
            }, false);
        });
        
        libraryDropZone.addEventListener('drop', handleLibraryDrop, false);
        
        function handleLibraryDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            importAllPalettes(files);
        }
        
        // Add a context menu for the library
        document.addEventListener('contextmenu', function(e) {
            const libraryPanel = document.querySelector('.library-panel');
            if (libraryPanel.contains(e.target)) {
                e.preventDefault();
                
                // Create context menu
                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.style.position = 'absolute';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.backgroundColor = 'white';
                contextMenu.style.border = '1px solid #ccc';
                contextMenu.style.borderRadius = '5px';
                contextMenu.style.padding = '5px 0';
                contextMenu.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                contextMenu.style.zIndex = '1000';
                
                // Add menu items
                const exportAllItem = document.createElement('div');
                exportAllItem.textContent = 'Export All Palettes';
                exportAllItem.style.padding = '8px 15px';
                exportAllItem.style.cursor = 'pointer';
                exportAllItem.addEventListener('mouseover', () => {
                    exportAllItem.style.backgroundColor = '#f0f0f0';
                });
                exportAllItem.addEventListener('mouseout', () => {
                    exportAllItem.style.backgroundColor = 'transparent';
                });
                exportAllItem.addEventListener('click', () => {
                    document.body.removeChild(contextMenu);
                    exportAllPalettes();
                });
                
                const importItem = document.createElement('div');
                importItem.textContent = 'Import Palettes';
                importItem.style.padding = '8px 15px';
                importItem.style.cursor = 'pointer';
                importItem.addEventListener('mouseover', () => {
                    importItem.style.backgroundColor = '#f0f0f0';
                });
                importItem.addEventListener('mouseout', () => {
                    importItem.style.backgroundColor = 'transparent';
                });
                importItem.addEventListener('click', () => {
                    document.body.removeChild(contextMenu);
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.multiple = true;
                    input.accept = '.json';
                    input.addEventListener('change', (e) => {
                        importAllPalettes(e.target.files);
                    });
                    input.click();
                });
                
                contextMenu.appendChild(exportAllItem);
                contextMenu.appendChild(importItem);
                
                document.body.appendChild(contextMenu);
                
                // Close context menu when clicking elsewhere
                document.addEventListener('click', function closeMenu() {
                    if (document.body.contains(contextMenu)) {
                        document.body.removeChild(contextMenu);
                    }
                    document.removeEventListener('click', closeMenu);
                });
            }
        });

        // Load default palettes from files
        function loadDefaultPalettes() {
            // First, check if we have a palettes directory
            fetch('palettes/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Palettes directory not found');
                    }
                    return response.text();
                })
                .then(html => {
                    // Parse the directory listing to find JSON files
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = doc.querySelectorAll('a');
                    
                    const jsonFiles = Array.from(links)
                        .map(link => link.href)
                        .filter(href => href.endsWith('.json'))
                        .map(href => href.split('/').pop());
                    
                    if (jsonFiles.length === 0) {
                        throw new Error('No palette files found');
                    }
                    
                    // Check if we already have palettes in local storage
                    const savedLibrary = localStorage.getItem('paletteLibrary');
                    const existingPalettes = savedLibrary ? JSON.parse(savedLibrary) : [];
                    
                    if (existingPalettes.length === 0) {
                        // If no palettes in local storage, load all palette files
                        loadPaletteFiles(jsonFiles, []);
                    } else {
                        // If we already have palettes, ask if user wants to merge
                        if (confirm(`You already have ${existingPalettes.length} palettes in your library. Would you like to add the palettes from the game? Click Cancel to keep only your existing palettes.`)) {
                            loadPaletteFiles(jsonFiles, existingPalettes);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading default palettes:', error);
                    // If we can't load from files, use the built-in defaults if needed
                    if (paletteLibrary.length === 0) {
                        useBuiltInDefaults();
                    }
                });
        }

        // Load palette files one by one
        function loadPaletteFiles(fileNames, existingPalettes) {
            const existingNames = existingPalettes.map(p => p.name);
            let loadedCount = 0;
            let newPalettes = [...existingPalettes];
            
            fileNames.forEach(fileName => {
                fetch(`palettes/${fileName}`)
                    .then(response => response.json())
                    .then(palette => {
                        // Only add if not already in the library
                        if (!existingNames.includes(palette.name)) {
                            newPalettes.push(palette);
                            loadedCount++;
                        }
                        
                        // If this is the last file, update the library
                        if (loadedCount === fileNames.length) {
                            paletteLibrary = newPalettes;
                            saveLibrary();
                            renderLibrary();
                            console.log(`Loaded ${loadedCount} new palettes from files.`);
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading palette ${fileName}:`, error);
                    });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadLibrary();
            loadDefaultPalettes();
        });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>

